apiVersion: openliberty.io/v1beta1
kind: OpenLibertyApplication
metadata:
  name: scoring-mp
spec:
  initContainers:
  - name: init-bootstrap-properties
    image: docker.io/busybox:1.32
    imagePullPolicy: "Always"
    resources:
      requests:
        cpu: 250m
        memory: 256Mi
    command:
      - /bin/sh
      - -c
      - |
        echo "mp.messaging.connector.liberty-kafka.bootstrap.servers=${KAFKA_BROKERS}" > tmpfile
        echo "mp.messaging.connector.liberty-kafka.security.protocol=SASL_SSL" >> tmpfile
        echo "mp.messaging.connector.liberty-kafka.ssl.protocol=TLSv1.2" >> tmpfile
        echo "mp.messaging.connector.liberty-kafka.sasl.mechanism=PLAIN" >> tmpfile
        echo "mp.messaging.connector.liberty-kafka.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"${KAFKA_USER}\" password=\"${KAFKA_PASSWORD}\";" >> tmpfile

        echo "mp.messaging.connector.liberty-kafka.ssl.truststore.location=/config/resources/security/es-ssl/es-cert.p12" >> tmpfile
        echo "mp.messaging.connector.liberty-kafka.ssl.truststore.password=${EVENTSTREAMS_TRUSTSTORE_PASSWORD}" >> tmpfile

        cp tmpfile /config/bootstrap.properties
    env:
      - name: KAFKA_BROKERS
        valueFrom:
          configMapKeyRef:
            key: brokers
            name: kafka-brokers
      - name: KAFKA_USER
        valueFrom:
          secretKeyRef:
            name: "eventstreams-cred"
            key: username
      - name: KAFKA_PASSWORD
        valueFrom:
          secretKeyRef:
            name: "eventstreams-cred"
            key: password
      - name: EVENTSTREAMS_TRUSTSTORE_PASSWORD
        valueFrom:
          secretKeyRef:
            name: "eventstreams-truststore-pwd"
            key: password
    securityContext:
      runAsUser: 0
    volumeMounts:
      # /config is a default symlink to /opt/ol/wlp/usr/servers/defaultServer
      - name: openliberty-bootstrap
        mountPath: /config/
